<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON to Video - Web Tester</title>
    <style>
        :root {
            --primary: #6366f1;
            --bg: #0f172a;
            --text: #f8fafc;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: #1e293b;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin-top: 0;
        }

        textarea {
            width: 100%;
            height: 400px;
            background: #020617;
            color: #10b981;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            resize: vertical;
        }

        button {
            margin-top: 1rem;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #status {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            display: none;
        }

        .loading {
            color: #eab308;
        }

        .success {
            color: #22c55e;
        }

        .error {
            color: #ef4444;
        }

        video {
            margin-top: 1rem;
            width: 100%;
            border-radius: 0.5rem;
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üé¨ JSON to Video Tester</h1>
        <p>Edit the JSON below and click Generate.</p>
        <textarea id="jsonInput">{
  "name": "web-showcase",
  "duration": 9,
  "resolution": "full-hd",
  "visuals": [
    {
      "type": "IMAGE",
      "src": "https://picsum.photos/seed/zvid1/1920/1080",
      "enterBegin": 0, "exitEnd": 3, "enterAnimation": "fade", "exitAnimation": "fade"
    },
    {
      "type": "IMAGE",
      "src": "https://picsum.photos/seed/zvid2/1920/1080",
      "enterBegin": 3, "exitEnd": 6, "enterAnimation": "fade", "exitAnimation": "fade"
    },
    {
      "type": "IMAGE",
      "src": "https://picsum.photos/seed/zvid3/1920/1080",
      "enterBegin": 6, "exitEnd": 9, "enterAnimation": "fade", "exitAnimation": "fade"
    },
    {
      "type": "TEXT",
      "text": "PREMIUM QUALITY",
      "position": "bottom-center",
      "style": {
        "fontSize": "150px",
        "color": "#ffffff",
        "fontWeight": "900",
        "textShadow": "0 10px 30px rgba(0,0,0,0.8)"
      },
      "enterBegin": 1, "exitEnd": 8, "enterAnimation": "smoothup"
    }
  ],
  "subtitle": {
    "styles": { "fontSize": 80, "color": "#facc15", "marginV": 50 },
    "captions": [
      { "start": 0, "end": 3, "text": "Stunning visuals..." },
      { "start": 3, "end": 6, "text": "...powered by zvid..." },
      { "start": 6, "end": 9, "text": "...at 1080p resolution!" }
    ]
  }
}</textarea>
        <button id="generateBtn">Generate Video</button>
        <div id="status"></div>
        <video id="videoPlayer" controls></video>
        <div id="downloadContainer" style="margin-top: 10px;"></div>
    </div>

    <script>
        const btn = document.getElementById('generateBtn');
        const status = document.getElementById('status');
        const video = document.getElementById('videoPlayer');
        const input = document.getElementById('jsonInput');
        const downloadContainer = document.getElementById('downloadContainer');

        btn.onclick = async () => {
            btn.disabled = true;
            status.style.display = 'block';
            status.className = 'loading';
            status.innerText = '‚öôÔ∏è Submitting job...';
            video.style.display = 'none';
            downloadContainer.innerHTML = '';

            try {
                // 1. Submit Job
                const project = JSON.parse(input.value);
                const submitResp = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(project)
                });

                if (!submitResp.ok) {
                    const error = await submitResp.json();
                    throw new Error(error.detail || 'Job submission failed');
                }

                const { job_id, status: initialStatus } = await submitResp.json();
                status.innerText = `‚öôÔ∏è Job ${initialStatus}... (ID: ${job_id})`;

                // 2. Poll for Status
                let isComplete = false;
                while (!isComplete) {
                    await new Promise(r => setTimeout(r, 2000)); // Wait 2s

                    const polResp = await fetch(`/status/${job_id}`);
                    if (!polResp.ok) throw new Error("Failed to check status");

                    const job = await polResp.json();

                    if (job.status === 'completed') {
                        isComplete = true;
                        status.className = 'success';
                        status.innerText = '‚úÖ Video generated successfully!';

                        // 3. Display
                        const downloadUrl = `/download/${job_id}`;
                        video.src = downloadUrl;
                        video.style.display = 'block';
                        video.play();

                        downloadContainer.innerHTML = `<a href="${downloadUrl}" target="_blank" style="color: #6366f1;">üîó Download Video</a>`;
                    } else if (job.status === 'failed') {
                        throw new Error(job.error || 'Video generation failed');
                    } else {
                        status.innerText = `‚öôÔ∏è Processing... ${job.progress || 0}%`;
                    }
                }

            } catch (err) {
                status.className = 'error';
                status.innerText = '‚ùå Error: ' + err.message;
            } finally {
                btn.disabled = false;
            }
        };
    </script>
</body>

</html>